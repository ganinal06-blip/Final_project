# Проект "Даша бот"
#### *Ганина Елизавета, Меерова Мария*

В данном проекте мы создаём бота, который будет автоматически по пользователям из списка проверять их нахождение в чате. Если есть какой-то пользователь, который не состоит в списке - бот сам будет удалять их из чата/канала.

### Что будет видеть пользователь?

Пользователь взаимодействует с ботом через Telegram. При вводе команды `/start` бот будет отвечать приветственным сообщением и показывать пользовательское меню. После отправки сообщения на проверку пользователь увидит подтверждение о принятии заявки на модерацию и результат проверки. В случае блокировки бот уведомит об этом администратора.

``` sh
Примерный диалог:
Админ (личка): /start
Бот (личка): Привет! Пришлите файл allowed.txt...
Админ: [отправляет allowed.txt]
Бот: Список разрешенных пользователей обновлен: 42 записей.

(в группе)
Админ: /clean
Бот: Проверено: 42. Найдено: 3. Забанено: 3.
```

Таким образом, пользователь видит диалоговые окна с текстом от бота, кнопки меню и уведомления о статусе своих сообщений.

![img-1.png](images/img-1.png)
---

### Какие задачи необходимо выполнить?

Проект включает в себя следующие основные задачи: 

1. Регистрация бота в BotFather - получить токен
2. Настройка окружения - .env, requirements.txt
3. Реализация обработчиков (`handlers.py`) - приём файла, /start, /clean, работа с new_chat_members и on_any_message
4. Репозиторий/модели/БД (`models.py`, db.py, `repository.py`) - sqlite + SQLAlchemy async
5. Модуль модерации (`services.py`) — filter_unauthorized, ban_users, clean_chat
6. Утилиты (`utils.py`) - парсинг allowed.txt
7. Логирование действий (таблица `action_logs`)
8. Тестирование - unit-тесты для services.py и интеграционные тесты сценария upload → clean
9. Документация - README, инструкции по развёртыванию
10. Деплой/контейнеризация - Dockerfile, docker-compose, запуск на сервере

![img-2.png](images/img-2.png)

---

### Схема архитектуры
Схема архитектуры бота-модератора. На схеме показано взаимодействие пользователя через Telegram с Telegram API, дальнейшая передача сообщений на сервер бота (реализация на aiogram), где происходит проверка и модерация. Бот взаимодействует с базой данных (для хранения логов и статусов) и с админ-панелью/чатом модераторов

![img-3.png](images/img-3.png)

---

### Сколько времени потребуется на каждую задачу?
Примерные оценки времени на выполнение задач:

|                                     Задача | Оценка времени (рабочих дней) |
|-------------------------------------------:| ----------------------------: |
|              Регистрация в BotFather, .env |                   0.5 — 1 дн. |
|         Настройка окружения и зависимостей |                   0.5 — 1 дн. |
|    handlers.py (интерфейс, загрузка файла) |                     1 — 2 дн. |
|              utils.py (парсер allowed.txt) |                   0.5 — 1 дн. |
|            models.py + db.py (схема, init) |                     1 — 2 дн. |
|                              repository.py |                     1 — 2 дн. |
|             services.py (логика clean/ban) |                     2 — 3 дн. |
|        Локальное тестирование и интеграция |                     1 — 2 дн. |
|                  Тесты (unit + интеграция) |                     1 — 2 дн. |
|                Dockerfile + docker-compose |                     1 — 2 дн. |
|   Документация (README, схемы, инструкции) |                   0.5 — 1 дн. |
|                                      Итого |      ~9 — 17 рабочих дней |

---

### Кто что делает в команде?
Распределение ролей в команде: 
#### *Лиза:*
- **Команды бота**: /add_user, /remove_user, /list_users
- **Интерфейс**: кнопки, меню, сообщения
- **Работа с файлами**: загрузка и обработка списка пользователей
- **Тестирование**: интеграционные тесты и UI-тесты
- **Документация**: инструкции и описание проекта
- 
#### *Маша*
- **Команды бота**: /start, /clean, /stats
- **Логика модерации**: автоматическая проверка пользователей
- **База данных**: настройка и работа с пользователями
- **Тестирование**: unit-тесты для модерации
- **Деплой**: настройка сервера и запуск
> Важно: Лиза — тимлид. Разделение минимально пересекается, чтобы было проще делать PR и code-review.

#### *Лиза:*

* bot_app.py - точка сборки, регистрация команд, запуск polling
* handlers.py - интерфейс бота: /start, приём allowed.txt, обработка событий new_chat_members, обёртка для /clean (вызов services)
* utils.py - парсер allowed.txt, вспомогательные функции
* main.py - точка входа
* Интеграционные тесты, документация (README)

#### *Маша*

Основные обязанности (файлы и задачи):

* models.py - SQLAlchemy модели: AllowedUser, Member, ActionLog
* db.py - инициализация engine/AsyncSession, миграции/инициализация БД
* repository.py - доступ к БД
* services.py - логика модерации: filter_unauthorized, ban_users, clean_chat
* config.py - загрузка переменных окружения, безопасная работа с токеном
* Unit-тесты для services и repository, Dockerfile/docker-compose

*Общие задачи (делаем вместе)*:
- Проектирование архитектуры
- Настройка CI/CD
- Код-ревью
- Финальное тестирование

<p align="center">
  <img src="images/img-4.jpeg" width="50%">
</p>


### Схема БД


  
    ALLOWED_USERS {
        int id PK
        string user_identifier UNIQUE
        datetime created_at
    }

    MEMBERS {
        int id PK
        string chat_id
        string user_id
        string username
        datetime last_seen
    }

    ACTION_LOGS {
        int id PK
        string chat_id
        string user_identifier
        string action
        datetime timestamp
        string reason
    }

